name: deploy docker image with gcr

on:
  push:
    branches:
      - master

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  GCE_INSTANCE: instance1
  GCE_INSTANCE_REGION: us-west1-b
  KEY: ${{ secrets.KEY }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: print variable
        run: |
          echo $PROJECT_ID $GCE_INSTANCE $GCE_INSTANCE_REGION $KEY

      - name: checkout
        uses: actions/checkout@v2

      # CD 시작 부분 (GCE 배포 설정)
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: $KEY
          project_id: $PROJECT_ID

      # GCE Docker 인증
      - run: |-
          gcloud --quiet auth configure-docker

      # Build the Docker image
      - name: Build
        run: |-
          docker build --tag "gcr.io/$PROJECT_ID/$GCE_INSTANCE-image:$KEY" .
      # Push the Docker image to Google Container Registry
      # Docker image를 Google Container Registry push 함.
      # 이때 Google Container Registry API 사용 해야함.
      - name: Publish
        run: |-
          docker push "gcr.io/$PROJECT_ID/$GCE_INSTANCE-image:$KEY"

      # GCE에 Docker 실제 배포 (도커 컨테이너 업데이트)
      # Google Container Registry에 등록된 Docker로 업데이트 되어 배포 되는 원리
      - name: Deploy
        run: |-
          gcloud compute instances update-container "$GCE_INSTANCE" \
            --zone "$GCE_INSTANCE_ZONE" \
            --container-image "gcr.io/$PROJECT_ID/$GCE_INSTANCE-image:$KEY"
